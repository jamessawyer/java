- [Chapter1 Introduction - java concurrent](http://www.pascal-man.com/navigation/faq-java-browser/java-concurrent/JC-Ch1-4-bse069-kbe096.pdf)

计算机使用多进程的原因：

- 资源利用：当一个程序等待 **I/O** 时，为什么不让其他程序继续运行，避免浪费CPU呢？
- 公平性：多个用户或者程序拥有公平使用计算机资源的权利。避免某个单一大程序长时间霸占计算机的使用
- 便利性：我们通常希望创建更小的程序去执行单一任务，然后协调这些任务，这比直接一个大的程序执行所有的任务要好



## 什么是线程？

- "一个轻量级的进程" - 每个进程都可以拥有多个线程
- 线程允许多个程序流在单一的进程中共存
- 尽管线程和其他线程共享进程范围的资源（如内存和文件），但是他们都有自己的程序计数器，堆栈和局部变量



## 线程的优点

1. 利用多个处理器
2. 建模简单
3. 简化处理异步事件
4. 更具响应性的UI



> 1. 利用多个处理器

- 处理器行业当前将重点放在增加单个CPU上的内核数量上，而不是提高时钟速度上
- 用多线程设计良好的程序能同时在多处理器上同时运行，增加资源利用率
- 线程多单处理器也十分有用（当一个线程等待IO时，另一个线程能继续运行）



> 2.简化模型

- 线程可以将一个大而复杂的程序分解为更小的单元，同时任然提供具有单个顺序程序的错觉
- 使程序能更简单的去实现和维护，并可能提升性能



> 3. 简化处理异步事件

- 假设一个服务器是单线程的，如果它从socket中读取数据，但是数据获取不到时-会出现 **读阻塞**
- 这不仅会阻塞当前请求，还会阻塞系统中的其它请求
- 当每个请求能够在自己的线程中运行，某个请求在等待IO时，其它请求仍然可以继续运行



> 4.更具响应式的UI

- 单线程GUI程序通常在执行耗时操作时都会假死，变为没有响应状态
- 通过在自己的线程中执行操作，GUI仍然可以正常的响应
- 使用线程能够提升响应性和GUI应用的效率



## 线程的风险

1. 安全性危害（Safety hazards）
2. 活跃性危害（Liveness hazards）
3. 性能危害（Performance hazards）



> 1. 安全性危害

如果代码缺乏足够的同步，使用多线程可能出现意向不到的结果

```java
public class UnsafeSequence {
  private int value;
  
  // 返回一个唯一值
  public int getNext() {
    return value++;
  }
}
```

这里的 **`value++`** 很容易让人误解是一个操作，其实它是3个操作组合的 **复合操作**

- 读取
- 修改
- 写入

如果多个线程同时读写，可能导致以下结果，2次调用，但是value只增加 **`1`** 的情况：

```
// 时序图
A  - value -> 9 ---- 9+1=10 ---- value-> 10
B  ------- value->9 -------- 9+1=10 ------- value=10
```

这其实是：

- 这就是所谓的 **竞态条件（race conditions）**
- 为了阻止竞态条件的发生，**访问共享资源时必须是 同步的（`synchronized`）**
- 没有这种约束，编译器，运行时（JVM）和硬件能够随意的时机和顺序执行操作最大化性能



> 2.活跃性危害

- 设计差的多线程应用可能导致 **死锁（`deadlocks`）**,从而导致应用崩溃或者一直循环下去
- 例如线程A等待线程B释放某个资源，但是B就是不释放，这样A就无法继续下去（**活跃失败**）



> 3.性能危害

- **当使用线程带来性能的提升的同时，它也带来了开销**
- **上下文切换（保存当前线程状态，切换到另一个线程，恢复之前线程的状态等待）是很昂贵的开销**
- 线程约到，CPU花费在调度线程上的时间越多



## 线程无处不在

- 所有的JAVA程序都使用了线程，即使你在代码中没有显式的使用线程
- JVM管理任务（垃圾回收（GC），终止（finalization）等等）.Servlets处理客户端请求
- 处理并行不是可选的，所有的开发者都必须意识到这一点
- 当使用某些框架，可能自动在应用中引入并行
- 因为框架要运行你的代码，所以你的代码必须是线程安全的（**thread-safe**）
- 例如，一个Servlet能在多个线程中同时被调用，因此Servlet必须是线程安全的

